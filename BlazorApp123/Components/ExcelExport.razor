@using BlazorApp123.Models
@inject IJSRuntime JSRuntime
@using DocumentFormat.OpenXml;
@using DocumentFormat.OpenXml.Packaging;
@using DocumentFormat.OpenXml.Spreadsheet;

@code {
    [Parameter] public List<Client> Clients { get; set; }

    public async Task ExportToExcel()
    {
        using var memoryStream = new MemoryStream();
        using (var spreadsheetDocument = SpreadsheetDocument.Create(memoryStream, SpreadsheetDocumentType.Workbook))
        {
            var workbookPart = spreadsheetDocument.AddWorkbookPart();
            workbookPart.Workbook = new Workbook();

            var worksheetPart = workbookPart.AddNewPart<WorksheetPart>();
            worksheetPart.Worksheet = new Worksheet(new SheetData());

            Sheets sheets = spreadsheetDocument.WorkbookPart.Workbook.AppendChild(new Sheets());
            Sheet sheet = new Sheet() { Id = spreadsheetDocument.WorkbookPart.GetIdOfPart(worksheetPart), SheetId = 1, Name = "Clients" };
            sheets.Append(sheet);

            var sheetData = worksheetPart.Worksheet.GetFirstChild<SheetData>();

            // Create header row
            var headerRow = new Row();
            headerRow.Append(new Cell { CellValue = new CellValue("ID"), DataType = CellValues.String });
            headerRow.Append(new Cell { CellValue = new CellValue("Name"), DataType = CellValues.String });
            headerRow.Append(new Cell { CellValue = new CellValue("Department"), DataType = CellValues.String });
            headerRow.Append(new Cell { CellValue = new CellValue("Phone"), DataType = CellValues.String });
            sheetData.Append(headerRow);

            // Add client data to rows
            foreach (var client in Clients)
            {
                var dataRow = new Row();
                dataRow.Append(new Cell { CellValue = new CellValue(client.ID.ToString()), DataType = CellValues.Number });
                dataRow.Append(new Cell { CellValue = new CellValue(client.Name), DataType = CellValues.String });
                dataRow.Append(new Cell { CellValue = new CellValue(client.Department), DataType = CellValues.String });
                dataRow.Append(new Cell { CellValue = new CellValue(client.Phone), DataType = CellValues.String });
                sheetData.Append(dataRow);
            }

            workbookPart.Workbook.Save();
        }

        var fileName = "Clients.xlsx";
        var fileBytes = memoryStream.ToArray();
        await JSRuntime.InvokeVoidAsync("downloadFile", fileName, Convert.ToBase64String(fileBytes));
    }
}

